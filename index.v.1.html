<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Carti√±os - Gestor de Gastos Inteligente</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { background: linear-gradient(135deg,#0f0f23 0%,#1a0a2e 100%); min-height:100vh; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif; padding-bottom:80px; }
    .card-neon { background:rgba(15,15,35,0.8); border:2px solid transparent; background-clip:padding-box; position:relative; }
    .card-neon::before { content:''; position:absolute; inset:-2px; background:linear-gradient(45deg,#FF006E,#8338EC,#3A86FF,#FFBE0B); border-radius:inherit; z-index:-1; opacity:.5; }
    .btn-neon { transition:all .2s ease; } .btn-neon:active{transform:scale(.98);filter:brightness(1.1);} .btn-neon:hover{transform:translateY(-2px);box-shadow:0 0 20px rgba(131,56,236,.6);}
    .input-neon { background:rgba(0,0,0,.3); border:2px solid rgba(131,56,236,.5); transition:all .3s; color:#fff; } .input-neon:focus{outline:none;border-color:#8338EC;box-shadow:0 0 15px rgba(131,56,236,.3);}
    .stat-card { background:linear-gradient(135deg,rgba(131,56,236,.2),rgba(255,0,110,.1)); backdrop-filter:blur(10px); }
    .delete-btn { opacity:0; transition:opacity .2s ease; } .item-hover:hover .delete-btn{opacity:1;}
    .pulse-animation { animation:pulse-glow 2s infinite; }
    @keyframes pulse-glow { 0%,100%{box-shadow:0 0 10px rgba(131,56,236,.5);} 50%{box-shadow:0 0 20px rgba(255,0,110,.7);} }
  </style>
</head>
<body class="text-white">

  <!-- Contenedor principal -->
  <div id="app" class="min-h-screen p-4 md:p-8 transition-opacity duration-500 ease-in-out"></div>

  <!-- Modales -->
  <div id="modal-sueldo" class="hidden fixed inset-0 bg-black/70 items-center justify-center z-50">
    <div class="card-neon max-w-sm w-full p-6 rounded-lg text-center">
      <h2 class="text-xl font-bold mb-4">üí∞ Confirmar sueldo</h2>
      <input id="input-sueldo" type="number" inputmode="decimal" class="input-neon w-full p-3 rounded mb-4" placeholder="Introduce tu sueldo" />
      <div class="flex gap-3 justify-center">
        <button onclick="confirmarSueldo()" class="btn-neon bg-green-600 px-5 py-2 rounded font-bold">Confirmar</button>
        <button onclick="cerrarModal('modal-sueldo')" class="btn-neon bg-red-600 px-5 py-2 rounded font-bold">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="modal-gasto" class="hidden fixed inset-0 bg-black/70 items-center justify-center z-50">
    <div class="card-neon max-w-sm w-full p-6 rounded-lg text-center">
      <h2 class="text-xl font-bold mb-4">‚ûñ A√±adir gasto</h2>
      <input id="gasto-desc-modal" type="text" class="input-neon w-full p-3 rounded mb-2" placeholder="Descripci√≥n" />
      <input id="gasto-monto-modal" type="number" inputmode="decimal" class="input-neon w-full p-3 rounded mb-4" placeholder="Monto (‚Ç¨)" />
      <select id="gasto-cuenta-modal" class="input-neon w-full p-3 rounded mb-4"></select>
      <div class="flex gap-3 justify-center">
        <button onclick="confirmarGastoModal()" class="btn-neon bg-green-600 px-5 py-2 rounded font-bold">Guardar</button>
        <button onclick="cerrarModal('modal-gasto')" class="btn-neon bg-red-600 px-5 py-2 rounded font-bold">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="modal-ingreso" class="hidden fixed inset-0 bg-black/70 items-center justify-center z-50">
    <div class="card-neon max-w-sm w-full p-6 rounded-lg text-center">
      <h2 class="text-xl font-bold mb-4">‚ûï A√±adir ingreso</h2>
      <input id="ingreso-desc-modal" type="text" class="input-neon w-full p-3 rounded mb-2" placeholder="Descripci√≥n" />
      <input id="ingreso-monto-modal" type="number" inputmode="decimal" class="input-neon w-full p-3 rounded mb-4" placeholder="Monto (‚Ç¨)" />
      <select id="ingreso-cuenta-modal" class="input-neon w-full p-3 rounded mb-4"></select>
      <div class="flex gap-3 justify-center">
        <button onclick="confirmarIngresoModal()" class="btn-neon bg-green-600 px-5 py-2 rounded font-bold">Guardar</button>
        <button onclick="cerrarModal('modal-ingreso')" class="btn-neon bg-red-600 px-5 py-2 rounded font-bold">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Barra inferior estilo iOS -->
  <div class="fixed bottom-0 left-0 right-0 z-50 bg-gradient-to-r from-purple-900/90 to-pink-900/90 backdrop-blur-lg border-t-2 border-purple-500/30 shadow-lg">
    <div class="flex justify-around items-center py-2">
      <button onclick="cambiarVista('principal')" class="flex flex-col items-center text-white hover:text-pink-400 transition"><i data-lucide="home" class="w-7 h-7"></i><span class="text-xs">Inicio</span></button>
      <button onclick="cambiarVista('dinheiros')" class="flex flex-col items-center text-white hover:text-pink-400 transition"><i data-lucide="credit-card" class="w-7 h-7"></i><span class="text-xs">Di√±eiros</span></button>
      <button onclick="cambiarVista('estadisticas')" class="flex flex-col items-center text-white hover:text-pink-400 transition"><i data-lucide="bar-chart-3" class="w-7 h-7"></i><span class="text-xs">Stats</span></button>
      <button onclick="cambiarVista('objetivos')" class="flex flex-col items-center text-white hover:text-pink-400 transition"><i data-lucide="target" class="w-7 h-7"></i><span class="text-xs">Ahorro</span></button>
      <button onclick="cambiarVista('calendario')" class="flex flex-col items-center text-white hover:text-pink-400 transition"><i data-lucide="calendar" class="w-7 h-7"></i><span class="text-xs">Calendario</span></button>
      <button onclick="exportarCSV()" class="flex flex-col items-center text-white hover:text-pink-400 transition"><i data-lucide="download" class="w-7 h-7"></i><span class="text-xs">Exportar</span></button>
    </div>
  </div>

  <script>
    // Estado global
    let state = {
      sueldo: localStorage.getItem('sueldo') || '',
      diaCobro: localStorage.getItem('diaCobro') || '1',
      gastosRecurrentes: JSON.parse(localStorage.getItem('gastosRecurrentes') || '[]'),
      gastos: JSON.parse(localStorage.getItem('gastos') || '[]'),
      ingresos: JSON.parse(localStorage.getItem('ingresos') || '[]'),
      ajustes: JSON.parse(localStorage.getItem('ajustes') || '[]'),
      objetivosAhorro: JSON.parse(localStorage.getItem('objetivosAhorro') || '[]'),
      categorias: JSON.parse(localStorage.getItem('categorias') || '["Alimentaci√≥n","Transporte","Entretenimiento","Salud","Hogar","Ropa","Otros"]'),
      cuentas: JSON.parse(localStorage.getItem('cuentas') || '[{"id":1,"nombre":"Cuenta Principal","tipo":"banco","saldoInicial":0,"saldo":0}]'),
      alertasConfig: JSON.parse(localStorage.getItem('alertasConfig') || '{"diasParaCobro":3,"porcentajeGastoMitadMes":50,"alertaObjetivosEnRiesgo":true}'),
      vista: 'principal',
      alertasMostradas: [],
      ultimaActualizacionRecurrentes: localStorage.getItem('ultimaActualizacionRecurrentes') || '',
      ultimaActualizacionSueldo: localStorage.getItem('ultimaActualizacionSueldo') || '',
      hoySimulado: localStorage.getItem('hoySimulado') || '',
      editando: null
    };

    // Helpers de modal
    function abrirModal(id){const el=document.getElementById(id); if(!el)return; el.classList.remove('hidden'); el.classList.add('flex');}
    function cerrarModal(id){const el=document.getElementById(id); if(!el)return; el.classList.add('hidden'); el.classList.remove('flex');}

    // Guardado
    let saveTimeout=null;
    function guardarEstadoDebounce(){ if(saveTimeout) clearTimeout(saveTimeout); saveTimeout=setTimeout(guardarEstado,800); }
    function guardarEstado(){
      localStorage.setItem('sueldo',state.sueldo);
      localStorage.setItem('diaCobro',state.diaCobro);
      localStorage.setItem('gastosRecurrentes',JSON.stringify(state.gastosRecurrentes));
      localStorage.setItem('gastos',JSON.stringify(state.gastos));
      localStorage.setItem('ingresos',JSON.stringify(state.ingresos));
      localStorage.setItem('ajustes',JSON.stringify(state.ajustes));
      localStorage.setItem('objetivosAhorro',JSON.stringify(state.objetivosAhorro));
      localStorage.setItem('categorias',JSON.stringify(state.categorias));
      localStorage.setItem('cuentas',JSON.stringify(state.cuentas));
      localStorage.setItem('alertasConfig',JSON.stringify(state.alertasConfig));
      localStorage.setItem('ultimaActualizacionRecurrentes',state.ultimaActualizacionRecurrentes);
      localStorage.setItem('ultimaActualizacionSueldo',state.ultimaActualizacionSueldo);
      localStorage.setItem('hoySimulado',state.hoySimulado||'');
    }

    // Migraci√≥n saldos
    state.cuentas.forEach(c=>{ if(c.saldoInicial===undefined){ c.saldoInicial=c.saldo||0; } });

    // Colores categor√≠a
    function obtenerColorCategoria(cat){
      const pre={'Alimentaci√≥n':'#FF006E','Transporte':'#8338EC','Entretenimiento':'#FFBE0B','Salud':'#FB5607','Hogar':'#3A86FF','Ropa':'#FF006E','Otros':'#00F5FF'};
      if(pre[cat]) return pre[cat];
      const colores=['#FF006E','#8338EC','#FFBE0B','#FB5607','#3A86FF','#00F5FF','#10b981','#f59e0b'];
      let hash=0; for(let i=0;i<cat.length;i++){ hash=cat.charCodeAt(i)+((hash<<5)-hash); }
      return colores[Math.abs(hash)%colores.length];
    }

    // Fecha/hoy
    function obtenerHoy(){ return state.hoySimulado ? new Date(state.hoySimulado) : new Date(); }

    // Per√≠odo
    function obtenerPeriodoPagoActual(){
      const hoy=obtenerHoy(); const d=hoy.getDate(), m=hoy.getMonth(), y=hoy.getFullYear();
      const diaCobro=parseInt(state.diaCobro||1); let inicioPeriodo, finPeriodo;
      if(d>=diaCobro){ inicioPeriodo=new Date(y,m,diaCobro); finPeriodo=new Date(y,m+1,diaCobro-1); }
      else { inicioPeriodo=new Date(y,m-1,diaCobro); finPeriodo=new Date(y,m,diaCobro-1); }
      return {inicioPeriodo,finPeriodo};
    }

    // Saldos
    function calcularSaldoCuenta(id){
      const c=state.cuentas.find(x=>x.id===id); if(!c) return 0;
      let saldo=parseFloat(c.saldoInicial||0);
      state.ingresos.forEach(i=>{ if(i.cuentaId===id) saldo+=parseFloat(i.monto); });
      state.gastos.forEach(g=>{ if(g.cuentaId===id) saldo-=parseFloat(g.monto); });
      state.ajustes.forEach(a=>{ if(a.cuentaId===id) saldo+=(a.tipo==='positivo'?parseFloat(a.monto):-parseFloat(a.monto)); });
      return saldo;
    }
    function recalcularSaldosCuentas(){ state.cuentas.forEach(c=>{ c.saldo=calcularSaldoCuenta(c.id); }); }

    // Sueldo mensual
    function procesarSueldoMensual(){
      const {inicioPeriodo}=obtenerPeriodoPagoActual();
      const inicioStr=inicioPeriodo.toISOString().slice(0,10);
      if(state.ultimaActualizacionSueldo===inicioStr) return;
      document.getElementById('input-sueldo').value=state.sueldo||'';
      const modal=document.getElementById('modal-sueldo');
      modal.dataset.fechaCobro=inicioStr;
      modal.dataset.fechaIngreso=inicioPeriodo.toISOString();
      abrirModal('modal-sueldo');
    }
    function confirmarSueldo(){
      const modal=document.getElementById('modal-sueldo');
      const monto=parseFloat(document.getElementById('input-sueldo').value||'0');
      if(monto>0){
        state.ingresos.push({ descripcion:'Sueldo', monto, cuentaId:state.cuentas[0]?.id||1, fecha:modal.dataset.fechaIngreso, id:Date.now() });
        state.ultimaActualizacionSueldo=modal.dataset.fechaCobro;
        recalcularSaldosCuentas(); guardarEstado();
        alert('‚úÖ Sueldo confirmado y registrado');
      }
      cerrarModal('modal-sueldo'); render();
    }

    // Recurrentes
    function procesarGastosRecurrentes(){
      const {inicioPeriodo}=obtenerPeriodoPagoActual();
      const inicioStr=inicioPeriodo.toISOString().slice(0,10);
      if(state.ultimaActualizacionRecurrentes===inicioStr) return;
      const antes=state.gastos.length;
      state.gastosRecurrentes.forEach(gr=>{
        state.gastos.push({ descripcion:`${gr.nombre} (Recurrente)`, monto:gr.monto, categoria:gr.categoria, cuentaId:gr.cuentaId||state.cuentas[0]?.id||1, fecha:inicioPeriodo.toISOString(), id:Date.now()+Math.random(), esRecurrente:true });
      });
      state.ultimaActualizacionRecurrentes=inicioStr;
      recalcularSaldosCuentas(); guardarEstado();
      if(state.gastos.length>antes) alert('üîÑ Gastos recurrentes a√±adidos');
    }

    // Estad√≠sticas
    function calcularEstadisticas(){
      const hoy=obtenerHoy(); const {inicioPeriodo,finPeriodo}=obtenerPeriodoPagoActual();
      const diasRestantes=Math.ceil((finPeriodo-hoy)/(1000*60*60*24))+1;
      const diasTotalesPeriodo=Math.ceil((finPeriodo-inicioPeriodo)/(1000*60*60*24))+1;
      const diasTranscurridos=diasTotalesPeriodo-diasRestantes;

      const totalGastosRecurrentes=state.gastosRecurrentes.reduce((s,g)=>s+parseFloat(g.monto||0),0);
      const gastosDelPeriodo=state.gastos.filter(g=>{ const f=new Date(g.fecha); return f>=inicioPeriodo && f<=finPeriodo; });
      const totalGastosVariables=gastosDelPeriodo.reduce((s,g)=>s+parseFloat(g.monto||0),0);
      const ingresosDelPeriodo=state.ingresos.filter(i=>{ const f=new Date(i.fecha); return f>=inicioPeriodo && f<=finPeriodo; });
      const totalIngresos=ingresosDelPeriodo.reduce((s,i)=>s+parseFloat(i.monto||0),0);
      const ajustesDelPeriodo=state.ajustes.filter(a=>{ const f=new Date(a.fecha); return f>=inicioPeriodo && f<=finPeriodo; });
      const totalAjustes=ajustesDelPeriodo.reduce((s,a)=> s+(a.tipo==='positivo'?parseFloat(a.monto||0):-parseFloat(a.monto||0)),0);

      let ahorroDiarioNecesario=0;
      state.objetivosAhorro.forEach(o=>{
        if(o.activo!==false){
          const fechaLimite=new Date(o.fechaLimite);
          const diasPara=Math.ceil((fechaLimite-hoy)/(1000*60*60*24));
          const restante=parseFloat(o.metaMonto)-parseFloat(o.montoAhorrado||0);
          if(diasPara>0 && restante>0) ahorroDiarioNecesario+=restante/diasPara;
        }
      });

      const disponibleTotal=state.cuentas.reduce((s,c)=>s+parseFloat(c.saldo||0),0);
      const gastoPorDiaRestante=diasRestantes>0 ? (disponibleTotal - (ahorroDiarioNecesario*diasRestantes)) / diasRestantes : 0;

      const totalGastos=totalGastosRecurrentes+totalGastosVariables;
      const ingresoTotal=totalIngresos;
      const porcentajeGastado=ingresoTotal>0 ? (totalGastos/ingresoTotal)*100 : 0;

      return { hoy,diasRestantes,diasTotalesPeriodo,diasTranscurridos,totalGastosRecurrentes,totalGastosVariables,totalIngresos,totalAjustes,disponibleTotal,gastoPorDiaRestante:Math.max(0,gastoPorDiaRestante),ahorroDiarioNecesario,totalGastos,ingresoTotal,porcentajeGastado,inicioPeriodo,finPeriodo };
    }

    // Serie diaria para gr√°fico l√≠nea
    function obtenerSerieDiariaGastos(){
      const {inicioPeriodo,finPeriodo}=obtenerPeriodoPagoActual();
      const map={}; state.gastos.forEach(g=>{ const d=new Date(g.fecha); if(d>=inicioPeriodo && d<=finPeriodo){ const k=d.toISOString().slice(0,10); map[k]=(map[k]||0)+parseFloat(g.monto); } });
      const dias=[]; const cur=new Date(inicioPeriodo);
      while(cur<=finPeriodo){ const k=cur.toISOString().slice(0,10); dias.push({fecha:k,monto:map[k]||0}); cur.setDate(cur.getDate()+1); }
      return dias;
    }

    // Alertas
    function verificarAlertas(){
      const a=[]; const stats=calcularEstadisticas();
      if(state.alertasConfig.diasParaCobro>0 && stats.diasRestantes<=state.alertasConfig.diasParaCobro){ a.push({tipo:'info',mensaje:`‚è∞ Te quedan ${stats.diasRestantes} d√≠as para cobrar`}); }
      const mitad=Math.floor(stats.diasTotalesPeriodo/2);
      if(stats.diasTranscurridos<mitad && stats.porcentajeGastado>state.alertasConfig.porcentajeGastoMitadMes){ a.push({tipo:'warning',mensaje:`‚ö†Ô∏è Has gastado el ${stats.porcentajeGastado.toFixed(1)}% antes de mitad del per√≠odo`}); }
      if(state.alertasConfig.alertaObjetivosEnRiesgo){
        state.objetivosAhorro.forEach(o=>{
          if(o.activo!==false){
            const fechaLim=new Date(o.fechaLimite);
            const diasRest=Math.ceil((fechaLim-obtenerHoy())/(1000*60*60*24));
            const restante=parseFloat(o.metaMonto)-parseFloat(o.montoAhorrado||0);
            const diario=diasRest>0 ? restante/diasRest : 0;
            if(diario>stats.gastoPorDiaRestante && diasRest>0){
              a.push({tipo:'danger',mensaje:`üéØ "${o.nombre}" en riesgo. Necesitas ${diario.toFixed(2)}‚Ç¨/d√≠a`});
            }
          }
        });
      }
      state.cuentas.forEach(c=>{ if(c.saldo<0){ a.push({tipo:'danger',mensaje:`üí≥ "${c.nombre}" saldo negativo: ${c.saldo.toFixed(2)}‚Ç¨`}); } });
      state.alertasMostradas=a;
    }

    // Inactividad gastos
    function verificarInactividadGastos(dias=7){
      if(state.gastos.length===0) return;
      const ultimo=state.gastos[state.gastos.length-1];
      const diff=Math.floor((obtenerHoy()-new Date(ultimo.fecha))/(1000*60*60*24));
      if(diff>=dias) alert('‚ö†Ô∏è No has registrado gastos en una semana. ¬øTodo bien?');
    }

    // Exportar CSV
    function exportarCSV(){
      const rows=[['Tipo','Descripci√≥n','Monto','Categor√≠a','Cuenta','Fecha']];
      state.gastos.forEach(g=>{ const cuenta=state.cuentas.find(c=>c.id===g.cuentaId)?.nombre||''; rows.push(['Gasto',g.descripcion,g.monto,g.categoria||'',cuenta,g.fecha]); });
      state.ingresos.forEach(i=>{ const cuenta=state.cuentas.find(c=>c.id===i.cuentaId)?.nombre||''; rows.push(['Ingreso',i.descripcion,i.monto,'',cuenta,i.fecha]); });
      const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`cartinos_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // CRUD r√°pido
    function agregarGasto(){
      const texto=document.getElementById('gasto-texto')?.value||'';
      const cuentaId=parseInt(document.getElementById('gasto-cuenta').value);
      let monto=parseFloat(document.getElementById('gasto-monto')?.value||'0');
      let categoria=document.getElementById('gasto-categoria')?.value||'Otros';
      let descripcion='Gasto';
      if(texto){
        const p=parsearTextoInteligente(texto);
        if(p){ descripcion=p.descripcion; if(p.monto) monto=p.monto; categoria=p.categoria; }
        document.getElementById('gasto-texto').value='';
      }
      if(monto>0){
        state.gastos.push({ descripcion, monto, categoria, cuentaId, fecha:new Date().toISOString(), id:Date.now() });
        recalcularSaldosCuentas(); guardarEstado(); verificarAlertas(); render();
      }
    }
    function confirmarGastoModal(){
      const desc=document.getElementById('gasto-desc-modal').value||'Gasto';
      const monto=parseFloat(document.getElementById('gasto-monto-modal').value||'0');
      const cuentaId=parseInt(document.getElementById('gasto-cuenta-modal').value);
      if(monto>0){
        state.gastos.push({ descripcion:desc, monto, categoria:'Otros', cuentaId, fecha:new Date().toISOString(), id:Date.now() });
        recalcularSaldosCuentas(); guardarEstado(); cerrarModal('modal-gasto'); render();
      }
    }
    function confirmarIngresoModal(){
      const desc=document.getElementById('ingreso-desc-modal').value||'Ingreso';
      const monto=parseFloat(document.getElementById('ingreso-monto-modal').value||'0');
      const cuentaId=parseInt(document.getElementById('ingreso-cuenta-modal').value);
      if(monto>0){
        state.ingresos.push({ descripcion:desc, monto, cuentaId, fecha:new Date().toISOString(), id:Date.now() });
        recalcularSaldosCuentas(); guardarEstado(); cerrarModal('modal-ingreso'); render();
      }
    }

    // Parser inteligente (simple)
    const palabrasClave={
      'Alimentaci√≥n':['supermercado','mercadona','carrefour','lidl','aldi','comida','restaurante','bar','caf√©','pizza','hamburgues'],
      'Transporte':['gasolina','diesel','bus','metro','taxi','uber','parking','peaje','tren','renfe'],
      'Entretenimiento':['cine','teatro','netflix','spotify','hbo','disney','prime','juego','steam'],
      'Salud':['farmacia','m√©dico','hospital','seguro','gimnasio'],
      'Hogar':['alquiler','hipoteca','luz','agua','gas','internet','wifi','ikea','leroy'],
      'Ropa':['zara','hm','primark','mango','ropa','zapatillas','zapatos']
    };
    function parsearTextoInteligente(texto){
      if(!texto) return null; texto=texto.toLowerCase().trim();
      const montos=texto.match(/(\d+(?:[.,]\d+)?)/g); let monto=null;
      if(montos && montos.length>0){ monto=parseFloat(montos[montos.length-1].replace(',','.')); }
      let categoria='Otros';
      for(const [cat,pals] of Object.entries(palabrasClave)){ for(const p of pals){ if(texto.includes(p)){ categoria=cat; break; } } if(categoria!=='Otros') break; }
      let descripcion=texto;
      if(monto && montos){ const m=montos[montos.length-1]; const idx=descripcion.lastIndexOf(m); if(idx!==-1){ descripcion=descripcion.substring(0,idx)+descripcion.substring(idx+m.length); } }
      descripcion=descripcion.trim(); return { descripcion:descripcion||'Sin descripci√≥n', monto, categoria };
    }

    // Edici√≥n/eliminaci√≥n
    function eliminarGasto(id){ state.gastos=state.gastos.filter(g=>g.id!==id); recalcularSaldosCuentas(); guardarEstado(); render(); }
    function editarGasto(id){ const g=state.gastos.find(x=>x.id===id); if(!g) return; state.editando={tipo:'gasto',id,data:{...g}}; render(); }
    function guardarEdicionGasto(id){
      const g=state.gastos.find(x=>x.id===id); if(!g) return;
      g.descripcion=document.getElementById(`edit-desc-${id}`).value||'Gasto';
      g.monto=parseFloat(document.getElementById(`edit-monto-${id}`).value||g.monto);
      g.categoria=document.getElementById(`edit-cat-${id}`).value||g.categoria;
      g.cuentaId=parseInt(document.getElementById(`edit-cuenta-${id}`).value||g.cuentaId);
      state.editando=null; recalcularSaldosCuentas(); guardarEstado(); render();
    }
    function cancelarEdicion(){ state.editando=null; render(); }

    function eliminarIngreso(id){ state.ingresos=state.ingresos.filter(i=>i.id!==id); recalcularSaldosCuentas(); guardarEstado(); render(); }
    function editarIngreso(id){ const i=state.ingresos.find(x=>x.id===id); if(!i) return; state.editando={tipo:'ingreso',id,data:{...i}}; render(); }
    function guardarEdicionIngreso(id){
      const i=state.ingresos.find(x=>x.id===id); if(!i) return;
      i.descripcion=document.getElementById(`edit-desc-${id}`).value||'Ingreso';
      i.monto=parseFloat(document.getElementById(`edit-monto-${id}`).value||i.monto);
      i.cuentaId=parseInt(document.getElementById(`edit-cuenta-${id}`).value||i.cuentaId);
      state.editando=null; recalcularSaldosCuentas(); guardarEstado(); render();
    }

    // Recurrentes CRUD
    function agregarGastoRecurrente(){
      const nombre=document.getElementById('gasto-rec-nombre').value;
      const monto=parseFloat(document.getElementById('gasto-rec-monto').value||'0');
      const categoria=document.getElementById('gasto-rec-categoria').value;
      const cuentaId=parseInt(document.getElementById('gasto-rec-cuenta').value);
      if(nombre && monto>0){ state.gastosRecurrentes.push({nombre,monto,categoria,cuentaId,id:Date.now()}); guardarEstado(); render(); }
      document.getElementById('gasto-rec-nombre').value=''; document.getElementById('gasto-rec-monto').value='';
    }
    function eliminarGastoRecurrente(id){ state.gastosRecurrentes=state.gastosRecurrentes.filter(g=>g.id!==id); guardarEstado(); render(); }
    function editarGastoRecurrente(id){ const g=state.gastosRecurrentes.find(x=>x.id===id); if(!g) return; state.editando={tipo:'gastoRecurrente',id,data:{...g}}; render(); }
    function guardarEdicionGastoRecurrente(id){
      const g=state.gastosRecurrentes.find(x=>x.id===id); if(!g) return;
      g.nombre=document.getElementById(`edit-nombre-${id}`).value||g.nombre;
      g.monto=parseFloat(document.getElementById(`edit-monto-${id}`).value||g.monto);
      g.categoria=document.getElementById(`edit-cat-${id}`).value||g.categoria;
      g.cuentaId=parseInt(document.getElementById(`edit-cuenta-${id}`).value||g.cuentaId);
      state.editando=null; guardarEstado(); render();
    }

    // Objetivos
    function agregarObjetivo(){
      const nombre=document.getElementById('objetivo-nombre').value;
      const meta=parseFloat(document.getElementById('objetivo-meta').value||'0');
      const fecha=document.getElementById('objetivo-fecha').value;
      if(nombre && meta>0 && fecha){ state.objetivosAhorro.push({nombre,metaMonto:meta,fechaLimite:fecha,montoAhorrado:0,id:Date.now(),activo:true}); guardarEstado(); render(); }
      document.getElementById('objetivo-nombre').value=''; document.getElementById('objetivo-meta').value=''; document.getElementById('objetivo-fecha').value='';
    }
    function eliminarObjetivo(id){ state.objetivosAhorro=state.objetivosAhorro.filter(o=>o.id!==id); guardarEstado(); render(); }
    function anadirAhorroObjetivo(id,monto){ const o=state.objetivosAhorro.find(x=>x.id===id); if(!o || monto<=0) return; o.montoAhorrado=parseFloat(o.montoAhorrado||0)+parseFloat(monto); guardarEstado(); render(); }

    // Categor√≠as
    function agregarCategoria(){ const n=document.getElementById('nueva-categoria').value; if(n && !state.categorias.includes(n)){ state.categorias.push(n); guardarEstado(); render(); } document.getElementById('nueva-categoria').value=''; }
    function eliminarCategoria(cat){ if(state.categorias.length>1){ state.categorias=state.categorias.filter(c=>c!==cat); guardarEstado(); render(); } }

    // Cuentas
    function agregarCuenta(){
      const nombre=document.getElementById('cuenta-nombre').value;
      const tipo=document.getElementById('cuenta-tipo').value;
      const saldoInicial=parseFloat(document.getElementById('cuenta-saldo').value||'0');
      if(nombre){
        const nuevoId=Math.max(...state.cuentas.map(c=>c.id),0)+1;
        state.cuentas.push({id:nuevoId,nombre,tipo,saldoInicial,saldo:saldoInicial});
        guardarEstado(); render();
      }
      document.getElementById('cuenta-nombre').value=''; document.getElementById('cuenta-saldo').value='';
    }
    function eliminarCuenta(id){ if(state.cuentas.length>1){ state.cuentas=state.cuentas.filter(c=>c.id!==id); guardarEstado(); render(); } }

    // Calendario flexible
    function actualizarDiaCobro(nuevoDia){
      const prev=state.diaCobro; state.diaCobro=String(nuevoDia||1);
      state.ultimaActualizacionSueldo=''; state.ultimaActualizacionRecurrentes='';
      guardarEstado(); render(); alert(`üìÖ D√≠a de cobro actualizado de ${prev} a ${state.diaCobro}`);
    }
    function aplicarHoySimulado(fechaStr){ state.hoySimulado=fechaStr||''; guardarEstado(); render(); alert(state.hoySimulado?`üïí Simulando hoy: ${new Date(state.hoySimulado).toLocaleDateString('es-ES')}`:'üïí Simulaci√≥n desactivada'); }

    // Navegaci√≥n
    function cambiarVista(vista){ const app=document.getElementById('app'); app.classList.add('opacity-0'); setTimeout(()=>{ state.vista=vista; render(); app.classList.remove('opacity-0'); },250); }

    // Datos para gr√°fico pastel
    function obtenerDatosGraficoPeriodo(){
      const {inicioPeriodo,finPeriodo}=obtenerPeriodoPagoActual();
      const gastosDelPeriodo=state.gastos.filter(g=>{ const f=new Date(g.fecha); return f>=inicioPeriodo && f<=finPeriodo; });
      const porCat={}; gastosDelPeriodo.forEach(g=>{ const cat=g.categoria||'Otros'; porCat[cat]=(porCat[cat]||0)+parseFloat(g.monto); });
      return Object.entries(porCat).map(([nombre,valor])=>({nombre,valor}));
    }

    // Render
    function render(){
      procesarGastosRecurrentes();
      recalcularSaldosCuentas();
      verificarAlertas();
      verificarInactividadGastos(7);

      const app=document.getElementById('app');
      const stats=calcularEstadisticas();

      let html=`<div class="max-w-7xl mx-auto">`;
      html += `${state.alertasMostradas.length>0?`
        <div class="mb-6 space-y-3">
          ${state.alertasMostradas.map(a=>`
            <div class="card-neon rounded-xl p-4 ${a.tipo==='danger'?'border-red-500':a.tipo==='warning'?'border-yellow-500':'border-blue-500'}">
              <p class="text-white">${a.mensaje}</p>
            </div>
          `).join('')}
        </div>`:''}`;

      if(state.vista==='principal'){
        html += `
          <div class="flex justify-center mb-8">
            <div class="stat-card rounded-3xl p-12 border-4 border-pink-500/50 max-w-2xl w-full text-center pulse-animation">
              <div class="flex items-center justify-center mb-4"><span class="text-6xl">üìÖ</span></div>
              <h2 class="text-2xl font-bold text-gray-300 mb-4">Puedes gastar hoy</h2>
              <p class="text-7xl md:text-8xl font-black text-yellow-400 mb-2">${stats.gastoPorDiaRestante.toFixed(2)}‚Ç¨</p>
              <p class="text-gray-400 text-lg">Te quedan ${stats.diasRestantes} d√≠as hasta cobrar</p>
              ${stats.ahorroDiarioNecesario>0?`
                <div class="mt-6 pt-6 border-t border-purple-500/30">
                  <p class="text-cyan-400 text-xl">üí° Intenta ahorrar ${stats.ahorroDiarioNecesario.toFixed(2)}‚Ç¨ hoy para tus objetivos</p>
                </div>
              `:''}
              <div class="mt-6 flex gap-3 justify-center">
                <button onclick="abrirModal('modal-gasto')" class="btn-neon bg-gradient-to-r from-pink-600 to-red-600 px-6 py-3 rounded-xl font-bold">‚ûñ A√±adir gasto</button>
                <button onclick="abrirModal('modal-ingreso')" class="btn-neon bg-gradient-to-r from-green-600 to-emerald-600 px-6 py-3 rounded-xl font-bold">‚ûï A√±adir ingreso</button>
                <button onclick="procesarSueldoMensual()" class="btn-neon bg-purple-600 px-6 py-3 rounded-xl font-bold">üí∞ Confirmar sueldo</button>
              </div>
            </div>
          </div>

          <div class="card-neon rounded-2xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4 text-white">üí∏ Agregar gasto r√°pido</h2>
            <p class="text-gray-400 text-sm mb-4">üí° Escribe directo: "mercadona 23.50" o "gasolina 45"</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input id="gasto-texto" type="text" class="input-neon px-4 py-3 rounded-xl" placeholder="ej: mercadona 23.50" onkeyup="if(event.key==='Enter') agregarGasto()" />
              <select id="gasto-cuenta" class="input-neon px-4 py-3 rounded-xl">
                ${state.cuentas.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join('')}
              </select>
              <button onclick="agregarGasto()" class="btn-neon bg-gradient-to-r from-pink-600 to-red-600 px-6 py-3 rounded-xl font-bold">‚ûï Agregar</button>
            </div>
            <input type="hidden" id="gasto-monto" />
            <input type="hidden" id="gasto-categoria" value="${state.categorias[0]}" />
          </div>

          ${state.gastos.length>0?`
            <div class="card-neon rounded-2xl p-6">
              <h3 class="text-xl font-bold text-white mb-4">üìù √öltimos gastos</h3>
              <div class="space-y-2">
                ${state.gastos.slice().reverse().slice(0,5).map(g=>{
                  const fecha=new Date(g.fecha); const cuenta=state.cuentas.find(c=>c.id===g.cuentaId);
                  const editando=state.editando && state.editando.tipo==='gasto' && state.editando.id===g.id;
                  if(editando){
                    return `
                      <div class="bg-black/30 rounded-xl p-3">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                          <input id="edit-desc-${g.id}" type="text" value="${g.descripcion}" class="input-neon px-2 py-1 rounded text-sm" />
                          <input id="edit-monto-${g.id}" type="number" step="0.01" value="${g.monto}" class="input-neon px-2 py-1 rounded text-sm" />
                          <select id="edit-cat-${g.id}" class="input-neon px-2 py-1 rounded text-sm">${state.categorias.map(cat=>`<option value="${cat}" ${g.categoria===cat?'selected':''}>${cat}</option>`).join('')}</select>
                          <select id="edit-cuenta-${g.id}" class="input-neon px-2 py-1 rounded text-sm">${state.cuentas.map(c=>`<option value="${c.id}" ${g.cuentaId===c.id?'selected':''}>${c.nombre}</option>`).join('')}</select>
                          <div class="flex gap-1">
                            <button onclick="guardarEdicionGasto(${g.id})" class="btn-neon bg-green-600 px-3 py-1 rounded text-sm">üíæ</button>
                            <button onclick="cancelarEdicion()" class="btn-neon bg-gray-600 px-3 py-1 rounded text-sm">‚ùå</button>
                          </div>
                        </div>
                      </div>`;
                  }
                  return `
                    <div class="item-hover flex justify-between items-center bg-black/30 rounded-xl p-3">
                      <div class="flex-1">
                        <div class="flex items-center gap-2">
                          <div class="w-3 h-3 rounded-full" style="background-color:${obtenerColorCategoria(g.categoria||'Otros')}"></div>
                          <span class="text-white font-semibold">${g.descripcion}</span>
                          ${g.esRecurrente?'<span class="text-xs bg-purple-600 px-2 py-1 rounded">Recurrente</span>':''}
                        </div>
                        <p class="text-gray-400 text-xs mt-1">${fecha.toLocaleDateString('es-ES')} - ${cuenta?cuenta.nombre:'Sin cuenta'}</p>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="text-red-400 font-bold">${parseFloat(g.monto).toFixed(2)}‚Ç¨</span>
                        <button onclick="editarGasto(${g.id})" class="delete-btn text-blue-500 hover:text-blue-400">‚úèÔ∏è</button>
                        <button onclick="eliminarGasto(${g.id})" class="delete-btn text-red-500 hover:text-red-400">‚ùå</button>
                      </div>
                    </div>`;
                }).join('')}
              </div>
            </div>`:''}
        `;
      } else if(state.vista==='dinheiros'){
        html += `
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card rounded-2xl p-6 border-2 border-purple-500/30"><div class="flex justify-between mb-2"><span class="text-gray-400 text-sm">Disponible total</span><span class="text-2xl">üí∞</span></div><p class="text-4xl font-black text-green-400">${stats.disponibleTotal.toFixed(2)}‚Ç¨</p></div>
            <div class="stat-card rounded-2xl p-6 border-2 border-pink-500/30"><div class="flex justify-between mb-2"><span class="text-gray-400 text-sm">Gasto por d√≠a</span><span class="text-2xl">üìÖ</span></div><p class="text-4xl font-black text-yellow-400">${stats.gastoPorDiaRestante.toFixed(2)}‚Ç¨</p></div>
            <div class="stat-card rounded-2xl p-6 border-2 border-blue-500/30"><div class="flex justify-between mb-2"><span class="text-gray-400 text-sm">D√≠as restantes</span><span class="text-2xl">‚è∞</span></div><p class="text-4xl font-black text-blue-400">${stats.diasRestantes}</p></div>
            <div class="stat-card rounded-2xl p-6 border-2 border-red-500/30"><div class="flex justify-between mb-2"><span class="text-gray-400 text-sm">Gastos del per√≠odo</span><span class="text-2xl">üí∏</span></div><p class="text-4xl font-black text-red-400">${stats.totalGastos.toFixed(2)}‚Ç¨</p></div>
          </div>

          <div class="card-neon rounded-2xl p-6">
            <h3 class="text-xl font-bold text-white mb-4">üí≥ Estado de cuentas</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              ${state.cuentas.map(c=>`
                <div class="bg-black/30 rounded-xl p-4">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-white font-semibold">${c.nombre}</span>
                    <span class="text-xs text-gray-400">${c.tipo==='banco'?'üè¶':c.tipo==='efectivo'?'üíµ':'üí≥'}</span>
                  </div>
                  <p class="text-2xl font-black ${c.saldo>=0?'text-green-400':'text-red-400'}">${c.saldo.toFixed(2)}‚Ç¨</p>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      } else if(state.vista==='estadisticas'){
        const datosGrafico=obtenerDatosGraficoPeriodo();
        html += `
          <div class="space-y-8">
            <div class="card-neon rounded-2xl p-6">
              <h2 class="text-2xl font-bold mb-4 text-white">üìÖ Per√≠odo actual</h2>
              <p class="text-gray-400">Del <span class="text-white font-semibold">${stats.inicioPeriodo.toLocaleDateString('es-ES')}</span> al <span class="text-white font-semibold">${stats.finPeriodo.toLocaleDateString('es-ES')}</span></p>
              <div class="grid grid-cols-2 gap-4 mt-4">
                <div><p class="text-gray-400 text-sm">D√≠as transcurridos</p><p class="text-2xl font-bold text-blue-400">${stats.diasTranscurridos}</p></div>
                <div><p class="text-gray-400 text-sm">D√≠as restantes</p><p class="text-2xl font-bold text-yellow-400">${stats.diasRestantes}</p></div>
              </div>
            </div>

            <div class="card-neon rounded-2xl p-6">
              <h2 class="text-2xl font-bold mb-6 text-white">üìä Distribuci√≥n de gastos por categor√≠a</h2>
              ${datosGrafico.length>0?`
                <canvas id="pieChart" height="280"></canvas>
                <div class="mt-6 space-y-3">
                  ${datosGrafico.map(d=>{ const total=datosGrafico.reduce((s,x)=>s+x.valor,0); const pct=(d.valor/total*100).toFixed(1);
                    return `
                      <div class="flex justify-between items-center bg-black/30 rounded-xl p-3">
                        <div class="flex items-center gap-3 flex-1">
                          <div class="w-4 h-4 rounded" style="background-color:${obtenerColorCategoria(d.nombre)}"></div>
                          <span class="text-white font-semibold">${d.nombre}</span>
                          <span class="text-gray-400 text-sm">(${pct}%)</span>
                        </div>
                        <span class="text-white font-bold">${d.valor.toFixed(2)}‚Ç¨</span>
                      </div>`;
                  }).join('')}
                </div>
              `:'<p class="text-gray-400 text-center py-8">No hay datos suficientes</p>'}
            </div>

            <div class="card-neon rounded-2xl p-6">
              <h3 class="text-xl font-bold text-white mb-4">üìà Progreso del per√≠odo</h3>
              <div class="mb-4">
                <div class="flex justify-between text-sm mb-2">
                  <span class="text-gray-400">Has gastado el ${stats.porcentajeGastado.toFixed(1)}% de tus ingresos</span>
                  <span class="text-white font-semibold">${stats.totalGastos.toFixed(2)}‚Ç¨ / ${stats.ingresoTotal.toFixed(2)}‚Ç¨</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-4">
                  <div class="h-4 rounded-full transition-all duration-500 ${stats.porcentajeGastado>80?'bg-red-500':stats.porcentajeGastado>50?'bg-yellow-500':'bg-green-500'}" style="width:${Math.min(stats.porcentajeGastado,100)}%"></div>
                </div>
              </div>
              <canvas id="dailyLineChart" height="220"></canvas>
            </div>
          </div>
        `;
      } else if(state.vista==='objetivos'){
        html += `
          <div class="card-neon rounded-2xl p-6">
            <h2 class="text-2xl font-bold mb-6 text-white">üéØ Objetivos de ahorro</h2>
            ${state.objetivosAhorro.length>0?`
              <div class="space-y-4 mb-6">
                ${state.objetivosAhorro.map(o=>{
                  const progreso=(parseFloat(o.montoAhorrado||0)/parseFloat(o.metaMonto))*100;
                  const fechaLim=new Date(o.fechaLimite); const diasRest=Math.ceil((fechaLim-obtenerHoy())/(1000*60*60*24));
                  return `
                    <div class="bg-black/30 rounded-xl p-6">
                      <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                          <h3 class="text-white font-bold text-lg mb-1">${o.nombre}</h3>
                          <p class="text-gray-400 text-sm">Fecha l√≠mite: ${fechaLim.toLocaleDateString('es-ES')} (${diasRest} d√≠as)</p>
                        </div>
                        <button onclick="eliminarObjetivo(${o.id})" class="text-red-500 hover:text-red-400">‚ùå</button>
                      </div>
                      <div class="mb-3">
                        <div class="flex justify-between text-sm mb-2">
                          <span class="text-gray-400">Progreso: ${progreso.toFixed(1)}%</span>
                          <span class="text-white font-semibold">${parseFloat(o.montoAhorrado||0).toFixed(2)}‚Ç¨ / ${parseFloat(o.metaMonto).toFixed(2)}‚Ç¨</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                          <div class="h-3 rounded-full transition-all duration-500" style="width:${Math.min(progreso,100)}%; background: linear-gradient(90deg,#8338EC,#FF006E);"></div>
                        </div>
                      </div>
                      <div class="flex gap-2">
                        <input id="ahorro-${o.id}" type="number" step="0.01" min="0" class="input-neon flex-1 px-4 py-2 rounded-xl" placeholder="A√±adir ahorro" onkeyup="if(event.key==='Enter'){const m=parseFloat(this.value||0); if(m>0){anadirAhorroObjetivo(${o.id},m); this.value='';}}"/>
                        <button onclick="const inp=document.getElementById('ahorro-${o.id}'); const m=parseFloat(inp.value||0); if(m>0){anadirAhorroObjetivo(${o.id},m); inp.value='';}" class="btn-neon bg-green-600 px-6 py-2 rounded-xl font-bold">üí∞ A√±adir</button>
                      </div>
                    </div>`;
                }).join('')}
              </div>
            `:'<p class="text-gray-400 text-center py-4 mb-6">No hay objetivos</p>'}
            <h3 class="text-xl font-bold mb-4 text-white">‚ûï Nuevo objetivo</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <input id="objetivo-nombre" type="text" class="input-neon px-4 py-3 rounded-xl" placeholder="Nombre" />
              <input id="objetivo-meta" type="number" step="0.01" min="0" class="input-neon px-4 py-3 rounded-xl" placeholder="Meta (‚Ç¨)" />
              <input id="objetivo-fecha" type="date" class="input-neon px-4 py-3 rounded-xl" />
              <button onclick="agregarObjetivo()" class="btn-neon bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-3 rounded-xl font-bold">üéØ Crear objetivo</button>
            </div>
          </div>
        `;
      } else if(state.vista==='calendario'){
        html += `
          <div class="space-y-6">
            <div class="card-neon rounded-2xl p-6">
              <h2 class="text-2xl font-bold mb-6 text-white">üìÜ Ajustes de calendario</h2>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="text-gray-300 block mb-2 font-semibold">D√≠a de cobro</label>
                  <div class="flex gap-2">
                    <input id="dia-cobro-input" type="number" min="1" max="31" value="${state.diaCobro}" class="input-neon w-full px-4 py-3 rounded-xl" />
                    <button onclick="actualizarDiaCobro(parseInt(document.getElementById('dia-cobro-input').value||1))" class="btn-neon bg-purple-600 px-4 py-3 rounded-xl font-bold">Aplicar</button>
                  </div>
                  <p class="text-gray-400 text-xs mt-2">Se re-procesa sueldo y recurrentes con el nuevo per√≠odo.</p>
                </div>
                <div>
                  <label class="text-gray-300 block mb-2 font-semibold">Simular ‚Äúhoy‚Äù</label>
                  <div class="flex gap-2">
                    <input id="hoy-simulado-input" type="date" value="${state.hoySimulado||''}" class="input-neon w-full px-4 py-3 rounded-xl" />
                    <button onclick="aplicarHoySimulado(document.getElementById('hoy-simulado-input').value)" class="btn-neon bg-blue-600 px-4 py-3 rounded-xl font-bold">Simular</button>
                    <button onclick="aplicarHoySimulado('')" class="btn-neon bg-gray-600 px-4 py-3 rounded-xl font-bold">Quitar</button>
                  </div>
                </div>
                <div class="stat-card rounded-2xl p-4 border-2 border-pink-500/30">
                  <p class="text-gray-300 text-sm">Per√≠odo actual:</p>
                  <p class="text-white font-semibold mt-1">${stats.inicioPeriodo.toLocaleDateString('es-ES')} ‚Üí ${stats.finPeriodo.toLocaleDateString('es-ES')}</p>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      html += `</div>`;
      app.innerHTML=html;

      // Iconos
      if(typeof lucide!=='undefined'){ lucide.createIcons(); }

      // Gr√°ficos
      if(state.vista==='estadisticas'){
        setTimeout(()=>{
          const datosGrafico=obtenerDatosGraficoPeriodo();
          const pie=document.getElementById('pieChart');
          if(pie && datosGrafico.length>0){
            new Chart(pie,{ type:'pie', data:{ labels:datosGrafico.map(d=>d.nombre), datasets:[{ data:datosGrafico.map(d=>d.valor), backgroundColor:datosGrafico.map(d=>obtenerColorCategoria(d.nombre)), borderWidth:2, borderColor:'#0f0f23' }] }, options:{ plugins:{ legend:{ position:'bottom', labels:{ color:'#fff' } } } } });
          }
          const line=document.getElementById('dailyLineChart');
          if(line){
            const serie=obtenerSerieDiariaGastos();
            new Chart(line,{ type:'line', data:{ labels:serie.map(s=>s.fecha), datasets:[{ label:'Gasto diario (‚Ç¨)', data:serie.map(s=>s.monto), borderColor:'#FF006E', backgroundColor:'rgba(255,0,110,0.2)', tension:0.25, fill:true }] }, options:{ plugins:{ legend:{ labels:{ color:'#fff' } } }, scales:{ x:{ ticks:{ color:'#ddd' }, grid:{ color:'rgba(255,255,255,0.1)' } }, y:{ ticks:{ color:'#ddd' }, grid:{ color:'rgba(255,255,255,0.1)' } } } } });
          }
        },100);
      }

      // Rellenar selects modales
      ['ingreso-cuenta-modal','gasto-cuenta-modal'].forEach(id=>{
        const sel=document.getElementById(id); if(sel){ sel.innerHTML=state.cuentas.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join(''); }
      });
    }

    // Inicial
    setTimeout(()=>{ recalcularSaldosCuentas(); procesarSueldoMensual(); procesarGastosRecurrentes(); },0);
    render();
  </script>
</body>
</html>
